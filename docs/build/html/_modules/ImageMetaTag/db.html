
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>ImageMetaTag.db &#8212; ImageMetaTag 0.7.8 documentation</title>
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">ImageMetaTag 0.7.8 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ImageMetaTag.db</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">This module contains a set of functions to create/write to/read</span>
<span class="sd">and maintain an sqlite3 database of image files and their associated metadata.</span>

<span class="sd">In normal usage it is primarily used by  :func:`ImageMetaTag.savefig` to</span>
<span class="sd">create the database as figures are saved. Once the metadata database has been</span>
<span class="sd">built up then the metadata can be loaded with :func:`ImageMetaTag.db.read`.</span>

<span class="sd">(C) Crown copyright Met Office. All rights reserved.</span>
<span class="sd">Released under BSD 3-Clause License. See LICENSE for more details.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">pdb</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="k">import</span> <span class="n">StringIO</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">ImageMetaTag</span> <span class="k">import</span> <span class="n">META_IMG_FORMATS</span>
<span class="kn">from</span> <span class="nn">ImageMetaTag</span> <span class="k">import</span> <span class="n">DEFAULT_DB_TIMEOUT</span>
<span class="kn">from</span> <span class="nn">ImageMetaTag</span> <span class="k">import</span> <span class="n">DEFAULT_DB_ATTEMPTS</span>
<span class="kn">from</span> <span class="nn">ImageMetaTag.img_dict</span> <span class="k">import</span> <span class="n">readmeta_from_image</span>
<span class="kn">from</span> <span class="nn">ImageMetaTag.img_dict</span> <span class="k">import</span> <span class="n">check_for_required_keys</span>

<span class="c1"># the name of the database table that holds the plot metadata</span>
<span class="n">SQLITE_IMG_INFO_TABLE</span> <span class="o">=</span> <span class="s1">&#39;img_info&#39;</span>
<span class="n">SQLITE_IMG_INFO_FNAME</span> <span class="o">=</span> <span class="s1">&#39;fname&#39;</span>


<div class="viewcode-block" id="info_key_to_db_name"><a class="viewcode-back" href="../../db.html#ImageMetaTag.db.info_key_to_db_name">[docs]</a><span class="k">def</span> <span class="nf">info_key_to_db_name</span><span class="p">(</span><span class="n">in_str</span><span class="p">):</span>
    <span class="s1">&#39;Consistently convert a name in the img_info dict database&#39;</span>
    <span class="k">return</span> <span class="n">in_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;__&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="db_name_to_info_key"><a class="viewcode-back" href="../../db.html#ImageMetaTag.db.db_name_to_info_key">[docs]</a><span class="k">def</span> <span class="nf">db_name_to_info_key</span><span class="p">(</span><span class="n">in_str</span><span class="p">):</span>
    <span class="s1">&#39;Inverse of info_key_to_db_name&#39;</span>
    <span class="c1"># convert to string, to remove unicode string</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">in_str</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="write_img_to_dbfile"><a class="viewcode-back" href="../../db.html#ImageMetaTag.db.write_img_to_dbfile">[docs]</a><span class="k">def</span> <span class="nf">write_img_to_dbfile</span><span class="p">(</span><span class="n">db_file</span><span class="p">,</span> <span class="n">img_filename</span><span class="p">,</span> <span class="n">img_info</span><span class="p">,</span> <span class="n">add_strict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">attempt_replace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">timeout</span><span class="o">=</span><span class="n">DEFAULT_DB_TIMEOUT</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Writes image metadata to a database.</span>

<span class="sd">    Arguments:</span>

<span class="sd">    * db_file - the database file to write to. If it does not exist, it will \</span>
<span class="sd">                be created.</span>
<span class="sd">    * img_filename - the filename of the image to which the metadata applies. \</span>
<span class="sd">                     Usually this is either the absolute path, or it is \</span>
<span class="sd">                     useful to make this the relative path, from the location \</span>
<span class="sd">                     of the database file.</span>
<span class="sd">    * img_info - a dictionary containing any number of  {tag_name: value} \</span>
<span class="sd">                 pairs to be stored.</span>

<span class="sd">    Options:</span>

<span class="sd">    * add_strict - passed into :func:`ImageMetaTag.db.write_img_to_open_db`</span>
<span class="sd">    * attempt_replace - passed to :func:`ImageMetaTag.db.write_img_to_open_db`</span>
<span class="sd">    * timeout - default timeout to try and write to the database.</span>

<span class="sd">    This is commonly used in :func:`ImageMetaTag.savefig`</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">img_info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Size of image info dict is zero&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">db_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># open the database:</span>
        <span class="n">dbcn</span><span class="p">,</span> <span class="n">dbcr</span> <span class="o">=</span> <span class="n">open_or_create_db_file</span><span class="p">(</span><span class="n">db_file</span><span class="p">,</span> <span class="n">img_info</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="c1"># now write:</span>
        <span class="n">write_img_to_open_db</span><span class="p">(</span><span class="n">dbcr</span><span class="p">,</span> <span class="n">img_filename</span><span class="p">,</span> <span class="n">img_info</span><span class="p">,</span>
                             <span class="n">add_strict</span><span class="o">=</span><span class="n">add_strict</span><span class="p">,</span>
                             <span class="n">attempt_replace</span><span class="o">=</span><span class="n">attempt_replace</span><span class="p">)</span>
        <span class="c1"># now commit that databasde entry and close:</span>
        <span class="n">dbcn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">dbcn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="read"><a class="viewcode-back" href="../../db.html#ImageMetaTag.db.read">[docs]</a><span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">db_file</span><span class="p">,</span> <span class="n">required_tags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tag_strings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
         <span class="n">db_timeout</span><span class="o">=</span><span class="n">DEFAULT_DB_TIMEOUT</span><span class="p">,</span>
         <span class="n">db_attempts</span><span class="o">=</span><span class="n">DEFAULT_DB_ATTEMPTS</span><span class="p">,</span>
         <span class="n">n_samples</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    reads in the database written by write_img_to_dbfile</span>

<span class="sd">    Options:</span>
<span class="sd">     * required_tags - a list of image tags to return, and to fail if not all are \</span>
<span class="sd">                       present</span>
<span class="sd">     * tag_strings - an input list that will be populated with the unique values of \</span>
<span class="sd">                     the image tags.</span>
<span class="sd">     * n_samples - if provided, only the given number of entries will be loaded \</span>
<span class="sd">                   from the database, at random. \</span>
<span class="sd">                   Must be an integer or None (default None)</span>

<span class="sd">    Returns:</span>
<span class="sd">     * a list of filenames (payloads for the :class:`ImageMetaTag.ImageDict` class )</span>
<span class="sd">     * a dictionary, by filename, containing a dictionary of the image metadata \</span>
<span class="sd">       as *tagname: value*</span>

<span class="sd">    If tag_strings is not supplied, then the returned dictionary will contain a</span>
<span class="sd">    large number of duplicated strings, which can be an inefficient use of memory</span>
<span class="sd">    with large databases. If tag_strings is supplied, it will be populated with a</span>
<span class="sd">    unique list of strings used as tags and the dictionary will only contain</span>
<span class="sd">    references to this list. This can reduce memory usage considerably, both for</span>
<span class="sd">    the dictionary itself but also of an :class:`ImageMetaTag.ImageDict` produced</span>
<span class="sd">    with the dictionary.</span>

<span class="sd">    Will return None, None if there is a problem.</span>

<span class="sd">    In older versions, this was named read_img_info_from_dbfile which will still work.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">db_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">db_file</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">n_tries</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">read_db</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">read_db</span> <span class="ow">and</span> <span class="n">n_tries</span> <span class="o">&lt;=</span> <span class="n">db_attempts</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># open the connection and the cursor:</span>
            <span class="n">dbcn</span><span class="p">,</span> <span class="n">dbcr</span> <span class="o">=</span> <span class="n">open_db_file</span><span class="p">(</span><span class="n">db_file</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">db_timeout</span><span class="p">)</span>
            <span class="c1"># read it:</span>
            <span class="n">f_list</span><span class="p">,</span> <span class="n">out_dict</span> <span class="o">=</span> <span class="n">read_img_info_from_dbcursor</span><span class="p">(</span><span class="n">dbcr</span><span class="p">,</span>
                                                           <span class="n">required_tags</span><span class="o">=</span><span class="n">required_tags</span><span class="p">,</span>
                                                           <span class="n">tag_strings</span><span class="o">=</span><span class="n">tag_strings</span><span class="p">,</span>
                                                           <span class="n">n_samples</span><span class="o">=</span><span class="n">n_samples</span><span class="p">)</span>
            <span class="c1"># close connection:</span>
            <span class="n">dbcn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">read_db</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">op_err</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;database is locked&#39;</span> <span class="ow">in</span> <span class="n">op_err</span><span class="o">.</span><span class="n">message</span><span class="p">:</span>
                <span class="c1"># database being locked is what the retries and timeouts are for:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> database timeout reading from file &quot;</span><span class="si">%s</span><span class="s1">&quot;, </span><span class="si">%s</span><span class="s1"> s&#39;</span> \
                        <span class="o">%</span> <span class="p">(</span><span class="n">dt_now_str</span><span class="p">(),</span> <span class="n">db_file</span><span class="p">,</span> <span class="n">n_tries</span> <span class="o">*</span> <span class="n">db_timeout</span><span class="p">))</span>
                <span class="n">n_tries</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">op_err</span><span class="o">.</span><span class="n">message</span> <span class="o">==</span> <span class="s1">&#39;no such table: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SQLITE_IMG_INFO_TABLE</span><span class="p">):</span>
                <span class="c1"># the db file exists, but it doesn&#39;t have anything in it:</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># everything else needs to be reported and raised immediately:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> for file </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">op_err</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">db_file</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># if we went through all the attempts then it is time to raise the error:</span>
    <span class="k">if</span> <span class="n">n_tries</span> <span class="o">&gt;</span> <span class="n">db_attempts</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> for file </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">op_err</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">db_file</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># close connection:</span>
    <span class="n">dbcn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">f_list</span><span class="p">,</span> <span class="n">out_dict</span></div>

<span class="n">read_img_info_from_dbfile</span> <span class="o">=</span> <span class="n">read</span>


<div class="viewcode-block" id="merge_db_files"><a class="viewcode-back" href="../../db.html#ImageMetaTag.db.merge_db_files">[docs]</a><span class="k">def</span> <span class="nf">merge_db_files</span><span class="p">(</span><span class="n">main_db_file</span><span class="p">,</span> <span class="n">add_db_file</span><span class="p">,</span> <span class="n">delete_add_db</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">delete_added_entries</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">attempt_replace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">add_strict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">db_timeout</span><span class="o">=</span><span class="n">DEFAULT_DB_TIMEOUT</span><span class="p">,</span>
                   <span class="n">db_attempts</span><span class="o">=</span><span class="n">DEFAULT_DB_ATTEMPTS</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Merges two ImageMetaTag database files, with the contents of add_db_file</span>
<span class="sd">    added to the main_db_file. The databases should have the same tags within</span>
<span class="sd">    them for the merge to work.</span>

<span class="sd">    Options:</span>

<span class="sd">    * add_strict - passed into :func:`ImageMetaTag.db.write_img_to_open_db`</span>
<span class="sd">    * attempt_replace - passed to :func:`ImageMetaTag.db.write_img_to_open_db`</span>
<span class="sd">    * delete_add_db - if True, the added file will be deleted afterwards</span>
<span class="sd">    * delete_added_entries - if delete_add_db is False, this will keep the \</span>
<span class="sd">                             add_db_file but remove the entries from it which \</span>
<span class="sd">                             were added to the main_db_file. This is useful \</span>
<span class="sd">                             if parallel processes are writing to the \</span>
<span class="sd">                             databases. Ignored if delete_add_db is True.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># read what we want to add in:</span>
    <span class="n">add_filelist</span><span class="p">,</span> <span class="n">add_tags</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">add_db_file</span><span class="p">,</span> <span class="n">db_timeout</span><span class="o">=</span><span class="n">db_timeout</span><span class="p">,</span> <span class="n">db_attempts</span><span class="o">=</span><span class="n">db_attempts</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">add_filelist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">add_filelist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">n_tries</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">wrote_db</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">wrote_db</span> <span class="ow">and</span> <span class="n">n_tries</span> <span class="o">&lt;=</span> <span class="n">db_attempts</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># open the main database</span>
                    <span class="n">dbcn</span><span class="p">,</span> <span class="n">dbcr</span> <span class="o">=</span> <span class="n">open_db_file</span><span class="p">(</span><span class="n">main_db_file</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">db_timeout</span><span class="p">)</span>
                    <span class="c1"># and add in the new contents:</span>
                    <span class="k">for</span> <span class="n">add_file</span><span class="p">,</span> <span class="n">add_info</span> <span class="ow">in</span> <span class="n">add_tags</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">write_img_to_open_db</span><span class="p">(</span><span class="n">dbcr</span><span class="p">,</span> <span class="n">add_file</span><span class="p">,</span> <span class="n">add_info</span><span class="p">,</span>
                                             <span class="n">add_strict</span><span class="o">=</span><span class="n">add_strict</span><span class="p">,</span>
                                             <span class="n">attempt_replace</span><span class="o">=</span><span class="n">attempt_replace</span><span class="p">)</span>
                    <span class="n">dbcn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                    <span class="c1"># if we got here, then we&#39;re good!</span>
                    <span class="n">wrote_db</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># finally close:</span>
                    <span class="n">dbcn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">op_err</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;database is locked&#39;</span> <span class="ow">in</span> <span class="n">op_err</span><span class="o">.</span><span class="n">message</span><span class="p">:</span>
                        <span class="c1"># database being locked is what the retries and timeouts are for:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> database timeout writing to file &quot;</span><span class="si">%s</span><span class="s1">&quot;, </span><span class="si">%s</span><span class="s1"> s&#39;</span> \
                                        <span class="o">%</span> <span class="p">(</span><span class="n">dt_now_str</span><span class="p">(),</span> <span class="n">main_db_file</span><span class="p">,</span> <span class="n">n_tries</span> <span class="o">*</span> <span class="n">db_timeout</span><span class="p">))</span>
                        <span class="n">n_tries</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># everything else needs to be reported and raised immediately:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> for file </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">op_err</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">main_db_file</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c1"># if we went through all the attempts then it is time to raise the error:</span>
            <span class="k">if</span> <span class="n">n_tries</span> <span class="o">&gt;</span> <span class="n">db_attempts</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> for file </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">op_err</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">main_db_file</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># delete or tidy:</span>
    <span class="k">if</span> <span class="n">delete_add_db</span><span class="p">:</span>
        <span class="n">rmfile</span><span class="p">(</span><span class="n">add_db_file</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">delete_added_entries</span><span class="p">:</span>
        <span class="n">del_plots_from_dbfile</span><span class="p">(</span><span class="n">add_db_file</span><span class="p">,</span> <span class="n">add_filelist</span><span class="p">,</span> <span class="n">do_vacuum</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">allow_retries</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skip_warning</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="open_or_create_db_file"><a class="viewcode-back" href="../../db.html#ImageMetaTag.db.open_or_create_db_file">[docs]</a><span class="k">def</span> <span class="nf">open_or_create_db_file</span><span class="p">(</span><span class="n">db_file</span><span class="p">,</span> <span class="n">img_info</span><span class="p">,</span> <span class="n">restart_db</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">DEFAULT_DB_TIMEOUT</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Opens a database file and sets up initial tables, then returns the connection and cursor.</span>

<span class="sd">    Arguments:</span>
<span class="sd">     * db_file - the database file to open.</span>
<span class="sd">     * img_info - a dictionary of image metadata to be saved to the database.</span>

<span class="sd">    Options:</span>
<span class="sd">     * restart_db - when Truem this deletes the current db file and starts again, \</span>
<span class="sd">                   if it already exists.</span>

<span class="sd">    Returns an open database connection (dbcn) and cursor (dbcr)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">db_file</span><span class="p">)</span> <span class="ow">or</span> <span class="n">restart_db</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">db_file</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">db_file</span><span class="p">)</span>
        <span class="c1"># create a new database file:</span>
        <span class="n">dbcn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_file</span><span class="p">)</span>
        <span class="n">dbcr</span> <span class="o">=</span> <span class="n">dbcn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="c1"># and create the table:</span>
        <span class="n">create_table_for_img_info</span><span class="p">(</span><span class="n">dbcr</span><span class="p">,</span> <span class="n">img_info</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># open the database file:</span>
        <span class="n">dbcn</span><span class="p">,</span> <span class="n">dbcr</span> <span class="o">=</span> <span class="n">open_db_file</span><span class="p">(</span><span class="n">db_file</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="c1"># check for the required table:</span>
        <span class="n">table_names</span> <span class="o">=</span> <span class="n">list_tables</span><span class="p">(</span><span class="n">dbcr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">SQLITE_IMG_INFO_TABLE</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_names</span><span class="p">:</span>
            <span class="c1"># create it if required:</span>
            <span class="n">create_table_for_img_info</span><span class="p">(</span><span class="n">dbcr</span><span class="p">,</span> <span class="n">img_info</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dbcn</span><span class="p">,</span> <span class="n">dbcr</span></div>


<span class="k">def</span> <span class="nf">create_table_for_img_info</span><span class="p">(</span><span class="n">dbcr</span><span class="p">,</span> <span class="n">img_info</span><span class="p">):</span>
    <span class="s1">&#39;Creates a database table, in a database cursor, to store for the input img_info&#39;</span>

    <span class="n">create_command</span> <span class="o">=</span> <span class="s1">&#39;CREATE TABLE </span><span class="si">{}</span><span class="s1">(</span><span class="si">{}</span><span class="s1"> TEXT PRIMARY KEY,&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SQLITE_IMG_INFO_TABLE</span><span class="p">,</span>
                                                                   <span class="n">SQLITE_IMG_INFO_FNAME</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">img_info</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">create_command</span> <span class="o">+=</span> <span class="s1">&#39; &quot;</span><span class="si">{}</span><span class="s1">&quot; TEXT,&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">info_key_to_db_name</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
    <span class="n">create_command</span> <span class="o">=</span> <span class="n">create_command</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
    <span class="c1"># Can make a rare race condition if multiple processes try to create the file at the same time;</span>
    <span class="c1"># If that happens, the error is:</span>
    <span class="c1"># sqlite3.OperationalError: table img_info already exists for file .......</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dbcr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">create_command</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">op_err</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;table </span><span class="si">{}</span><span class="s1"> already exists&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SQLITE_IMG_INFO_TABLE</span><span class="p">)</span> <span class="ow">in</span> <span class="n">op_err</span><span class="o">.</span><span class="n">message</span><span class="p">:</span>
            <span class="c1"># another process has just created the table, so sleep(1)</span>
            <span class="c1"># This is only when a db file is created so isn&#39;t called often</span>
            <span class="c1"># (and the race condition is rare!)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># everything else needs to be reported and raised immediately:</span>
            <span class="k">raise</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">(</span><span class="n">op_err</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">sq_err</span><span class="p">:</span>
        <span class="c1"># everything else needs to be reported and raised immediately:</span>
        <span class="k">raise</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">sq_err</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>


<div class="viewcode-block" id="open_db_file"><a class="viewcode-back" href="../../db.html#ImageMetaTag.db.open_db_file">[docs]</a><span class="k">def</span> <span class="nf">open_db_file</span><span class="p">(</span><span class="n">db_file</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">DEFAULT_DB_TIMEOUT</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Just opens an existing db_file, using timeouts but no retries.</span>

<span class="sd">    Returns an open database connection (dbcn) and cursor (dbcr)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">dbcn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_file</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
    <span class="n">dbcr</span> <span class="o">=</span> <span class="n">dbcn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">dbcn</span><span class="p">,</span> <span class="n">dbcr</span></div>


<div class="viewcode-block" id="read_db_file_to_mem"><a class="viewcode-back" href="../../db.html#ImageMetaTag.db.read_db_file_to_mem">[docs]</a><span class="k">def</span> <span class="nf">read_db_file_to_mem</span><span class="p">(</span><span class="n">db_file</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">DEFAULT_DB_TIMEOUT</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Opens a pre-existing database file into a copy held in memory. This can be accessed much</span>
<span class="sd">    faster when doing extenstive work (a lot of select operations, for instance).</span>

<span class="sd">    There is a time cost in doing this; it takes a few seconds to read in a large database,</span>
<span class="sd">    so it is only worth doing when doing a lot of operations.</span>

<span class="sd">    Tests on selects on a large-ish database (250k rows) suggested it was worth doing</span>
<span class="sd">    for &gt; 100 selects.</span>

<span class="sd">    Returns an open database connection (dbcn) and cursor (dbcr)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># read the database into an in-memory file object:</span>
    <span class="c1">#dbcn = sqlite3.connect(db_file)</span>
    <span class="n">dbcn</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">open_db_file</span><span class="p">(</span><span class="n">db_file</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
    <span class="n">memfile</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">dbcn</span><span class="o">.</span><span class="n">iterdump</span><span class="p">():</span>
        <span class="n">memfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
    <span class="n">dbcn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">memfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Create a database in memory and import from memfile</span>
    <span class="n">dbcn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;:memory:&quot;</span><span class="p">)</span>
    <span class="n">dbcn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span><span class="o">.</span><span class="n">executescript</span><span class="p">(</span><span class="n">memfile</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">dbcn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">dbcr</span> <span class="o">=</span> <span class="n">dbcn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">dbcn</span><span class="p">,</span> <span class="n">dbcr</span></div>


<div class="viewcode-block" id="write_img_to_open_db"><a class="viewcode-back" href="../../db.html#ImageMetaTag.db.write_img_to_open_db">[docs]</a><span class="k">def</span> <span class="nf">write_img_to_open_db</span><span class="p">(</span><span class="n">dbcr</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">img_info</span><span class="p">,</span>
                         <span class="n">add_strict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">attempt_replace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Does the work for write_img_to_dbfile to add an image</span>
<span class="sd">    to the open database cursor (dbcr)</span>

<span class="sd">    * add_strict: if True then it will report a ValueError if you \</span>
<span class="sd">                  try and include fields that aren&#39;t defined in the table. \</span>
<span class="sd">                  If False, then adding a new metadata tag to the \</span>
<span class="sd">                  database will cause it be rewritten with the new item \</span>
<span class="sd">                  as a new column using \</span>
<span class="sd">                  :func:`ImageMetaTag.db.recrete_table_new_cols` \</span>
<span class="sd">                  All pre-existing images will have \</span>
<span class="sd">                  the new tag set to &#39;None&#39;. It is best to avoid using \</span>
<span class="sd">                  this functionality as it can be slow for large \</span>
<span class="sd">                  databases. Instead, all images should be ideally have \</span>
<span class="sd">                  all expected metadata tags included from the start \</span>
<span class="sd">                  but set to &#39;None&#39; where they are not used.</span>
<span class="sd">    * attempt_replace: if True, then it will attempt to replace a database \</span>
<span class="sd">                  entry if the image is already present. \</span>
<span class="sd">                  Otherwise it will ignore it.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># now add in the information:</span>
    <span class="c1"># get the name of the fields from the cursor descripton:</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">dbcr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;select * from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">SQLITE_IMG_INFO_TABLE</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="n">field_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">dbcr</span><span class="o">.</span><span class="n">description</span><span class="p">]</span>
    <span class="c1"># convert these to keys:</span>
    <span class="n">field_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">db_name_to_info_key</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">]</span>
    <span class="c1"># now build the command</span>
    <span class="n">add_command</span> <span class="o">=</span> <span class="s1">&#39;INSERT INTO </span><span class="si">{}</span><span class="s1">(</span><span class="si">{}</span><span class="s1">,&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SQLITE_IMG_INFO_TABLE</span><span class="p">,</span>
                                              <span class="n">SQLITE_IMG_INFO_FNAME</span><span class="p">)</span>
    <span class="n">add_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">filename</span><span class="p">]</span>
    <span class="n">invalid_fieldnames</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">img_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">add_command</span> <span class="o">+=</span> <span class="s1">&#39; &quot;</span><span class="si">{}</span><span class="s1">&quot;,&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">info_key_to_db_name</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="n">add_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">:</span>
            <span class="c1"># this is a problem that needs sorting:</span>
            <span class="n">invalid_fieldnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">invalid_fieldnames</span> <span class="o">!=</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="n">add_strict</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Attempting to add a line to the database that &#39;</span>
                   <span class="s1">&#39;include fields not present in the database: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">invalid_fieldnames</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># need to recreate the database table afresh, because if we</span>
            <span class="c1"># don&#39;t then it won&#39;t be correctly labelled by column:</span>
            <span class="n">recrete_table_new_cols</span><span class="p">(</span><span class="n">dbcr</span><span class="p">,</span> <span class="n">field_names</span><span class="p">,</span> <span class="n">invalid_fieldnames</span><span class="p">)</span>

    <span class="c1"># add in the right number of ?</span>
    <span class="n">add_command</span> <span class="o">=</span> <span class="n">add_command</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;) VALUES(&#39;</span> <span class="o">+</span> <span class="s1">&#39;?,&#39;</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">add_list</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;?)&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dbcr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">add_command</span><span class="p">,</span> <span class="n">add_list</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">op_err_file</span><span class="p">:</span>
        <span class="n">err_check</span> <span class="o">=</span> <span class="s1">&#39;no such table: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SQLITE_IMG_INFO_TABLE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err_check</span> <span class="ow">in</span> <span class="n">op_err_file</span><span class="o">.</span><span class="n">message</span><span class="p">:</span>
            <span class="n">create_table_for_img_info</span><span class="p">(</span><span class="n">dbcr</span><span class="p">,</span> <span class="n">img_info</span><span class="p">)</span>
            <span class="n">dbcr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">add_command</span><span class="p">,</span> <span class="n">add_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">op_err_file</span>
    <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">attempt_replace</span><span class="p">:</span>
            <span class="c1"># try an INSERT OR REPLACE</span>
            <span class="n">add_repl_command</span> <span class="o">=</span> <span class="n">add_command</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;INSERT &#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;INSERT OR REPLACE &#39;</span><span class="p">)</span>
            <span class="c1"># if this fails, want it to report it&#39;s error message as is,</span>
            <span class="c1"># so do, or do not, there is no &#39;try&#39;:</span>
            <span class="n">dbcr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">add_repl_command</span><span class="p">,</span> <span class="n">add_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># this file is already in the database</span>
            <span class="c1"># (as the primary key, so do nothing...)</span>
            <span class="k">pass</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">pass</span></div>


<span class="k">def</span> <span class="nf">list_tables</span><span class="p">(</span><span class="n">dbcr</span><span class="p">):</span>
    <span class="s1">&#39;lists the tables present, from a database cursor&#39;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">dbcr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT name FROM sqlite_master WHERE type=&#39;table&#39;;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="n">table_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">result</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">table_names</span>


<div class="viewcode-block" id="read_img_info_from_dbcursor"><a class="viewcode-back" href="../../db.html#ImageMetaTag.db.read_img_info_from_dbcursor">[docs]</a><span class="k">def</span> <span class="nf">read_img_info_from_dbcursor</span><span class="p">(</span><span class="n">dbcr</span><span class="p">,</span> <span class="n">required_tags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tag_strings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">n_samples</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Reads from an open database cursor (dbcr) for</span>
<span class="sd">    :func:`ImageMetaTag.db.read` and other routines.</span>

<span class="sd">    Options</span>
<span class="sd">     * required_tags - a list of image tags to return, and to fail if not all \</span>
<span class="sd">                       are present</span>
<span class="sd">     * tag_strings - an input list that will be populated with the unique \</span>
<span class="sd">                     values of the image tags</span>
<span class="sd">     * n_samples - if provided, only the given number of entries will be \</span>
<span class="sd">                   loaded from the database, at random. Must be an integer \</span>
<span class="sd">                   or None (default None)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># read in the data from the database:</span>
    <span class="k">if</span> <span class="n">n_samples</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sel_com</span> <span class="o">=</span> <span class="s1">&#39;SELECT * FROM </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SQLITE_IMG_INFO_TABLE</span><span class="p">)</span>
        <span class="n">db_contents</span> <span class="o">=</span> <span class="n">dbcr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sel_com</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;n_samples must be an integer&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">n_samples</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;n_samples must be &gt; 1&#39;</span><span class="p">)</span>
        <span class="c1"># read only a sample of lines:</span>
        <span class="n">read_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;SELECT * FROM </span><span class="si">{0}</span><span class="s1"> WHERE </span><span class="si">{1}</span><span class="s1"> IN (SELECT </span><span class="si">{1}</span><span class="s1"> FROM </span><span class="si">{0}</span><span class="s1"> &#39;</span>
                    <span class="s1">&#39;ORDER BY RANDOM() LIMIT </span><span class="si">{2}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">read_cmd</span> <span class="o">=</span> <span class="n">read_cmd</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SQLITE_IMG_INFO_TABLE</span><span class="p">,</span>
                                   <span class="n">SQLITE_IMG_INFO_FNAME</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
        <span class="n">db_contents</span> <span class="o">=</span> <span class="n">dbcr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">read_cmd</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="c1"># and convert that to a useful dict/list combo:</span>
    <span class="n">filename_list</span><span class="p">,</span> <span class="n">out_dict</span> <span class="o">=</span> <span class="n">process_select_star_from</span><span class="p">(</span><span class="n">db_contents</span><span class="p">,</span> <span class="n">dbcr</span><span class="p">,</span>
                                                       <span class="n">required_tags</span><span class="o">=</span><span class="n">required_tags</span><span class="p">,</span>
                                                       <span class="n">tag_strings</span><span class="o">=</span><span class="n">tag_strings</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filename_list</span><span class="p">,</span> <span class="n">out_dict</span></div>


<div class="viewcode-block" id="process_select_star_from"><a class="viewcode-back" href="../../db.html#ImageMetaTag.db.process_select_star_from">[docs]</a><span class="k">def</span> <span class="nf">process_select_star_from</span><span class="p">(</span><span class="n">db_contents</span><span class="p">,</span> <span class="n">dbcr</span><span class="p">,</span> <span class="n">required_tags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">tag_strings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Converts the output from a select * from ....  command into a standard</span>
<span class="sd">    output format. Requires a database cursor (dbcr) to identify the field</span>
<span class="sd">    names.</span>

<span class="sd">    Options:</span>
<span class="sd">     * required_tags - a list of image tags to return, and to fail if not \</span>
<span class="sd">                       all are present</span>
<span class="sd">     * tag_strings - an input list that will be populated with the unique \</span>
<span class="sd">                     values of the image tags</span>

<span class="sd">    Returns:</span>
<span class="sd">     * as :func:`ImageMetaTag.db.read`, but filtered according to the select.</span>
<span class="sd">     * a list of filenames (payloads for the :class:`ImageMetaTag.ImageDict`)</span>
<span class="sd">     * a dictionary, by filename, containing a dictionary of the image \</span>
<span class="sd">       metadata as tagname: value</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># get the name of the fields from the cursor descripton:</span>
    <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">filename_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># get the name of the fields from the cursor descripton:</span>
    <span class="n">field_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">dbcr</span><span class="o">.</span><span class="n">description</span><span class="p">]</span>

    <span class="c1"># the required_tags input is a list of tag names (as strings):</span>
    <span class="k">if</span> <span class="n">required_tags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">required_tags</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Input required_tags should be a list of strings&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">test_str</span> <span class="ow">in</span> <span class="n">required_tags</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">test_str</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Input required_tags should be a list of strings&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">tag_strings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tag_strings</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Input tag_strings should be a list&#39;</span><span class="p">)</span>

    <span class="c1"># now iterate and make a dictionary to return,</span>
    <span class="c1"># with the tests outside the loops so they&#39;re not tested for every row and element:</span>
    <span class="k">if</span> <span class="n">required_tags</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tag_strings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db_contents</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">filename_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">img_info</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">tag_name</span><span class="p">,</span> <span class="n">tag_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">field_names</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                <span class="n">img_info</span><span class="p">[</span><span class="n">db_name_to_info_key</span><span class="p">(</span><span class="n">tag_name</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tag_val</span><span class="p">)</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_info</span>
            <span class="c1"># return None, None if the contents are empty:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filename_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_dict</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">required_tags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tag_strings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db_contents</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">filename_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">img_info</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">tag_name</span><span class="p">,</span> <span class="n">tag_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">field_names</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                <span class="n">tag_name_full</span> <span class="o">=</span> <span class="n">db_name_to_info_key</span><span class="p">(</span><span class="n">tag_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tag_name_full</span> <span class="ow">in</span> <span class="n">required_tags</span><span class="p">:</span>
                    <span class="n">img_info</span><span class="p">[</span><span class="n">tag_name_full</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tag_val</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">img_info</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">required_tags</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Database entry does not contain all of the required_tags&#39;</span><span class="p">)</span>

            <span class="n">out_dict</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_info</span>
            <span class="c1"># return None, None if the contents are empty:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filename_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_dict</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">required_tags</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tag_strings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># we want all tags, but we want them as referneces to a common list:</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db_contents</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">filename_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">img_info</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">tag_name</span><span class="p">,</span> <span class="n">tag_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">field_names</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                <span class="n">str_tag_val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tag_val</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># loacate the tag_string in the list:</span>
                    <span class="n">tag_index</span> <span class="o">=</span> <span class="n">tag_strings</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">str_tag_val</span><span class="p">)</span>
                    <span class="c1"># and refernece it:</span>
                    <span class="n">img_info</span><span class="p">[</span><span class="n">db_name_to_info_key</span><span class="p">(</span><span class="n">tag_name</span><span class="p">)]</span> <span class="o">=</span> <span class="n">tag_strings</span><span class="p">[</span><span class="n">tag_index</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="c1"># tag not yet in the tag_strings list, so</span>
                    <span class="c1"># add the new string onto the end:</span>
                    <span class="n">tag_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">str_tag_val</span><span class="p">)</span>
                    <span class="c1"># and reference it:</span>
                    <span class="n">img_info</span><span class="p">[</span><span class="n">db_name_to_info_key</span><span class="p">(</span><span class="n">tag_name</span><span class="p">)]</span> <span class="o">=</span> <span class="n">tag_strings</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_info</span>
            <span class="c1"># return None, None if the contents are empty:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filename_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_dict</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># we want to filter the tags, and we want them as referneces to a common list:</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db_contents</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">filename_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">img_info</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">tag_name</span><span class="p">,</span> <span class="n">tag_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">field_names</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                <span class="c1"># test to see if the tag name is required:</span>
                <span class="n">tag_name_full</span> <span class="o">=</span> <span class="n">db_name_to_info_key</span><span class="p">(</span><span class="n">tag_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tag_name_full</span> <span class="ow">in</span> <span class="n">required_tags</span><span class="p">:</span>
                    <span class="n">str_tag_val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tag_val</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># loacate the tag_string in the list:</span>
                        <span class="n">tag_index</span> <span class="o">=</span> <span class="n">tag_strings</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">str_tag_val</span><span class="p">)</span>
                        <span class="c1"># and refernece it:</span>
                        <span class="n">img_info</span><span class="p">[</span><span class="n">tag_name_full</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag_strings</span><span class="p">[</span><span class="n">tag_index</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="c1"># tag not yet in the tag_strings list, so</span>
                        <span class="c1"># add the new string onto the end:</span>
                        <span class="n">tag_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">str_tag_val</span><span class="p">)</span>
                        <span class="c1"># and reference it:</span>
                        <span class="n">img_info</span><span class="p">[</span><span class="n">tag_name_full</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag_strings</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_info</span>
            <span class="c1"># return None, None if the contents are empty:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filename_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_dict</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="c1"># we&#39;re good, return the data:</span>
    <span class="k">return</span> <span class="n">filename_list</span><span class="p">,</span> <span class="n">out_dict</span></div>


<div class="viewcode-block" id="del_plots_from_dbfile"><a class="viewcode-back" href="../../db.html#ImageMetaTag.db.del_plots_from_dbfile">[docs]</a><span class="k">def</span> <span class="nf">del_plots_from_dbfile</span><span class="p">(</span><span class="n">db_file</span><span class="p">,</span> <span class="n">filenames</span><span class="p">,</span> <span class="n">do_vacuum</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_retries</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">db_timeout</span><span class="o">=</span><span class="n">DEFAULT_DB_TIMEOUT</span><span class="p">,</span> <span class="n">db_attempts</span><span class="o">=</span><span class="n">DEFAULT_DB_ATTEMPTS</span><span class="p">,</span>
                          <span class="n">skip_warning</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    deletes a list of files from a database file created by :mod:`ImageMetaTag.db`</span>

<span class="sd">    * do_vacuum - if True, the database will be restructured/cleaned after the delete</span>
<span class="sd">    * allow_retries - if True, retries will be allowed if the database is locked.\</span>
<span class="sd">                    If False there are no retries, but sleep commands try to avoid the need\</span>
<span class="sd">                    when doing a large number of deletes.</span>
<span class="sd">    * db_timeout - overide default database timeouts, if doing retries</span>
<span class="sd">    * db_attempts - overide default number of attempts, if doing retries</span>
<span class="sd">    * skip_warning - do not warn if a filename, that has been requested to be deleted,\</span>
<span class="sd">                   does not exist in the database</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">fn_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">filenames</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fn_list</span> <span class="o">=</span> <span class="n">filenames</span>

    <span class="c1"># delete command to use:</span>
    <span class="n">del_cmd</span> <span class="o">=</span> <span class="s2">&quot;DELETE FROM </span><span class="si">{}</span><span class="s2"> WHERE </span><span class="si">{}</span><span class="s2">=?&quot;</span>
    <span class="k">if</span> <span class="n">db_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">db_file</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">fn_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">allow_retries</span><span class="p">:</span>
                <span class="c1"># split the list of filenames up into appropciately sized chunks, so that</span>
                <span class="c1"># concurrent delete commands each have a chance to complete:</span>
                <span class="c1"># 200 is arbriatily chosen, but seems to work</span>
                <span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">200</span>
                <span class="n">chunks</span> <span class="o">=</span> <span class="n">__gen_chunk_of_list</span><span class="p">(</span><span class="n">fn_list</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">chunk_o_filenames</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">:</span>
                    <span class="c1"># within each chunk of files, need to open the db, with time out retries etc:</span>
                    <span class="n">n_tries</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">wrote_db</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">while</span> <span class="ow">not</span> <span class="n">wrote_db</span> <span class="ow">and</span> <span class="n">n_tries</span> <span class="o">&lt;=</span> <span class="n">db_attempts</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># open the database</span>
                            <span class="n">dbcn</span><span class="p">,</span> <span class="n">dbcr</span> <span class="o">=</span> <span class="n">open_db_file</span><span class="p">(</span><span class="n">db_file</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">db_timeout</span><span class="p">)</span>
                            <span class="c1"># go through the file chunk, one by one, and delete:</span>
                            <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">chunk_o_filenames</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">dbcr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">del_cmd</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SQLITE_IMG_INFO_TABLE</span><span class="p">,</span>
                                                                <span class="n">SQLITE_IMG_INFO_FNAME</span><span class="p">),</span> <span class="p">(</span><span class="n">fname</span><span class="p">,))</span>
                                <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">op_err_file</span><span class="p">:</span>
                                    <span class="n">err_check</span> <span class="o">=</span> <span class="s1">&#39;no such table: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SQLITE_IMG_INFO_TABLE</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">op_err_file</span><span class="o">.</span><span class="n">message</span> <span class="o">==</span> <span class="n">err_check</span><span class="p">:</span>
                                        <span class="c1"># the db file exists, but it doesn&#39;t have anything in it:</span>
                                        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_warning</span><span class="p">:</span>
                                            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;WARNING: Unable to delete file entry &quot;</span><span class="si">{}</span><span class="s1">&quot; from&#39;</span>
                                                   <span class="s1">&#39; database &quot;</span><span class="si">{}</span><span class="s1">&quot; as database table is missing&#39;</span><span class="p">)</span>
                                            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">db_file</span><span class="p">))</span>
                                        <span class="k">return</span>

                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_warning</span><span class="p">:</span>
                                        <span class="c1"># if this fails, print a warning...</span>
                                        <span class="c1"># need to figure out why this might happen</span>
                                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;WARNING: unable to delete file entry:&#39;</span>
                                               <span class="s1">&#39; &quot;</span><span class="si">{}</span><span class="s1">&quot;, type &quot;</span><span class="si">{}</span><span class="s1">&quot; from database&#39;</span><span class="p">)</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">fname</span><span class="p">)))</span>
                            <span class="n">dbcn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                            <span class="c1"># if we got here, then we&#39;re good!</span>
                            <span class="n">wrote_db</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="c1"># finally close (for this chunk)</span>
                            <span class="n">dbcn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">op_err</span><span class="p">:</span>
                            <span class="k">if</span> <span class="s1">&#39;database is locked&#39;</span> <span class="ow">in</span> <span class="n">op_err</span><span class="o">.</span><span class="n">message</span><span class="p">:</span>
                                <span class="c1"># database being locked is what the retries and timeouts are for:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> database timeout deleting from file &quot;</span><span class="si">%s</span><span class="s1">&quot;, </span><span class="si">%s</span><span class="s1"> s&#39;</span> \
                                                <span class="o">%</span> <span class="p">(</span><span class="n">dt_now_str</span><span class="p">(),</span> <span class="n">db_file</span><span class="p">,</span> <span class="n">n_tries</span> <span class="o">*</span> <span class="n">db_timeout</span><span class="p">))</span>
                                <span class="n">n_tries</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">elif</span> <span class="s1">&#39;disk I/O error&#39;</span> <span class="ow">in</span> <span class="n">op_err</span><span class="o">.</span><span class="n">message</span><span class="p">:</span>
                                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> for file </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">op_err</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">db_file</span><span class="p">)</span>
                                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># everything else needs to be reported and raised immediately:</span>
                                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> for file </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">op_err</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">db_file</span><span class="p">)</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                    <span class="c1"># if we went through all the attempts then it is time to raise the error:</span>
                    <span class="k">if</span> <span class="n">n_tries</span> <span class="o">&gt;</span> <span class="n">db_attempts</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> for file </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">op_err</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">db_file</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># just open the database:</span>
                <span class="n">dbcn</span><span class="p">,</span> <span class="n">dbcr</span> <span class="o">=</span> <span class="n">open_db_file</span><span class="p">(</span><span class="n">db_file</span><span class="p">)</span>
                <span class="c1"># delete the contents:</span>
                <span class="k">for</span> <span class="n">i_fn</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fn_list</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">dbcr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">del_cmd</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SQLITE_IMG_INFO_TABLE</span><span class="p">),</span> <span class="p">(</span><span class="n">fname</span><span class="p">,))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_warning</span><span class="p">:</span>
                            <span class="c1"># if this fails, print a warning...</span>
                            <span class="c1"># need to figure out why this happens</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;WARNING: unable to delete file entry:&#39;</span>
                                   <span class="s1">&#39; &quot;</span><span class="si">{}</span><span class="s1">&quot;, type &quot;</span><span class="si">{}</span><span class="s1">&quot; from database&#39;</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">fname</span><span class="p">)))</span>
                    <span class="c1"># commit every 100 to give other processes a chance:</span>
                    <span class="k">if</span> <span class="n">i_fn</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">dbcn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># commit, and vacuum if required:</span>
                <span class="n">dbcn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">do_vacuum</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">allow_retries</span><span class="p">:</span>
                    <span class="c1"># need to re-open the db, if we allowed retries:</span>
                    <span class="n">dbcn</span><span class="p">,</span> <span class="n">dbcr</span> <span class="o">=</span> <span class="n">open_db_file</span><span class="p">(</span><span class="n">db_file</span><span class="p">)</span>
                <span class="n">dbcn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;VACUUM&quot;</span><span class="p">)</span>
                <span class="n">dbcn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">allow_retries</span><span class="p">:</span>
                <span class="n">dbcn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<span class="k">def</span> <span class="nf">__gen_chunk_of_list</span><span class="p">(</span><span class="n">in_list</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">):</span>
    <span class="s1">&#39;gnerator that yields a chunk of list, of length chunk size&#39;</span>
    <span class="k">for</span> <span class="n">ndx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_list</span><span class="p">),</span> <span class="n">chunk_size</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">in_list</span><span class="p">[</span><span class="n">ndx</span><span class="p">:</span><span class="nb">min</span><span class="p">(</span><span class="n">ndx</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_list</span><span class="p">))]</span>


<div class="viewcode-block" id="select_dbfile_by_tags"><a class="viewcode-back" href="../../db.html#ImageMetaTag.db.select_dbfile_by_tags">[docs]</a><span class="k">def</span> <span class="nf">select_dbfile_by_tags</span><span class="p">(</span><span class="n">db_file</span><span class="p">,</span> <span class="n">select_tags</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Selects from a database file the entries that match a dict of field names/acceptable values.</span>

<span class="sd">    Returns the output, processed by :func:`ImageMetaTag.db.process_select_star_from`</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">db_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sel_results</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">db_file</span><span class="p">):</span>
            <span class="n">sel_results</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># just open the database:</span>
            <span class="n">dbcn</span><span class="p">,</span> <span class="n">dbcr</span> <span class="o">=</span> <span class="n">open_db_file</span><span class="p">(</span><span class="n">db_file</span><span class="p">)</span>
            <span class="c1"># do the select:</span>
            <span class="n">sel_results</span> <span class="o">=</span> <span class="n">select_dbcr_by_tags</span><span class="p">(</span><span class="n">dbcr</span><span class="p">,</span> <span class="n">select_tags</span><span class="p">)</span>
            <span class="n">dbcn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">sel_results</span></div>


<div class="viewcode-block" id="select_dbcr_by_tags"><a class="viewcode-back" href="../../db.html#ImageMetaTag.db.select_dbcr_by_tags">[docs]</a><span class="k">def</span> <span class="nf">select_dbcr_by_tags</span><span class="p">(</span><span class="n">dbcr</span><span class="p">,</span> <span class="n">select_tags</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Selects from an open database cursor (dbcr) the entries that match a dict of field</span>
<span class="sd">    names &amp; acceptable values.</span>

<span class="sd">    Returns the output, processed by :func:`ImageMetaTag.db.process_select_star_from`</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">select_tags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># just read and return the whole thing:</span>
        <span class="k">return</span> <span class="n">read_img_info_from_dbcursor</span><span class="p">(</span><span class="n">dbcr</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># convert these to lists:</span>
        <span class="n">tag_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">select_tags</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">tag_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">select_tags</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tag_names</span><span class="p">]</span>
        <span class="c1"># Right... this is where I need to understand how to do a select!</span>
        <span class="c1">#select_command = &#39;SELECT * FROM %s WHERE symbol=?&#39; % SQLITE_IMG_INFO_TABLE</span>
        <span class="n">select_command</span> <span class="o">=</span> <span class="s1">&#39;SELECT * FROM </span><span class="si">%s</span><span class="s1"> WHERE &#39;</span> <span class="o">%</span> <span class="n">SQLITE_IMG_INFO_TABLE</span>
        <span class="n">n_tags</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tag_names</span><span class="p">)</span>

        <span class="n">use_tag_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i_tag</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">,</span> <span class="n">tag_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_tags</span><span class="p">)),</span> <span class="n">tag_names</span><span class="p">,</span> <span class="n">tag_values</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tag_val</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="c1"># if a list or tuple, then use IN:</span>
                <span class="n">select_command</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> IN (&#39;</span> <span class="o">%</span> <span class="n">info_key_to_db_name</span><span class="p">(</span><span class="n">tag_name</span><span class="p">)</span>
                <span class="n">select_command</span> <span class="o">+=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;?&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">tag_val</span><span class="p">))</span>
                <span class="n">select_command</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>
                <span class="k">if</span> <span class="n">i_tag</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">n_tags</span><span class="p">:</span>
                    <span class="n">select_command</span> <span class="o">+=</span> <span class="s1">&#39; AND &#39;</span>
                <span class="n">use_tag_values</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tag_val</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># do an exact match:</span>
                <span class="k">if</span> <span class="n">i_tag</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">n_tags</span><span class="p">:</span>
                    <span class="n">select_command</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> = ? AND &#39;</span> <span class="o">%</span> <span class="n">info_key_to_db_name</span><span class="p">(</span><span class="n">tag_name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">select_command</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> = ?&#39;</span> <span class="o">%</span> <span class="n">info_key_to_db_name</span><span class="p">(</span><span class="n">tag_name</span><span class="p">)</span>
                <span class="n">use_tag_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag_val</span><span class="p">)</span>
        <span class="n">db_contents</span> <span class="o">=</span> <span class="n">dbcr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">select_command</span><span class="p">,</span> <span class="n">use_tag_values</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="c1"># and convert that to a useful dict/list combo:</span>
        <span class="n">filename_list</span><span class="p">,</span> <span class="n">out_dict</span> <span class="o">=</span> <span class="n">process_select_star_from</span><span class="p">(</span><span class="n">db_contents</span><span class="p">,</span> <span class="n">dbcr</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">filename_list</span><span class="p">,</span> <span class="n">out_dict</span></div>


<div class="viewcode-block" id="recrete_table_new_cols"><a class="viewcode-back" href="../../db.html#ImageMetaTag.db.recrete_table_new_cols">[docs]</a><span class="k">def</span> <span class="nf">recrete_table_new_cols</span><span class="p">(</span><span class="n">dbcr</span><span class="p">,</span> <span class="n">current_cols</span><span class="p">,</span> <span class="n">new_cols</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    for a given database cursor (bdcr) this recreates a new version of the</span>
<span class="sd">    ImageMetaTag database table with new columns.</span>

<span class="sd">    This is a major change to a database, and takes place (deliberately)</span>
<span class="sd">    without any commit statements (otherwise the database file seen by other</span>
<span class="sd">    connections/processes will see an intermediate/incorrect database).</span>

<span class="sd">    Because of this, this process is slow and should be avoided if at all</span>
<span class="sd">    possible.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;WARNING: recreating database table with new image tags: </span><span class="si">{}</span><span class="s1">&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_cols</span><span class="p">))</span>

    <span class="c1"># read the cuirrent contents of the database:</span>
    <span class="n">_f_list</span><span class="p">,</span> <span class="n">img_infos</span> <span class="o">=</span> <span class="n">read_img_info_from_dbcursor</span><span class="p">(</span><span class="n">dbcr</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">dbcr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;select * from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">SQLITE_IMG_INFO_TABLE</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="n">current_flds</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">dbcr</span><span class="o">.</span><span class="n">description</span><span class="p">]</span>
    <span class="n">current_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">db_name_to_info_key</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">current_flds</span><span class="p">]</span>

    <span class="c1"># rename the current database table, checking to see if there is already</span>
    <span class="c1"># a tmp table (delete it if so):</span>
    <span class="n">table_names</span> <span class="o">=</span> <span class="n">list_tables</span><span class="p">(</span><span class="n">dbcr</span><span class="p">)</span>
    <span class="n">tmp_table</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_tmp&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SQLITE_IMG_INFO_TABLE</span><span class="p">)</span>
    <span class="n">drop_tmp_table_comm</span> <span class="o">=</span> <span class="s1">&#39;DROP TABLE &quot;</span><span class="si">{}</span><span class="s1">&quot;;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tmp_table</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tmp_table</span> <span class="ow">in</span> <span class="n">table_names</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;WARNING: database table </span><span class="si">{}</span><span class="s1"> already exists. Overwriting it now.&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tmp_table</span><span class="p">))</span>
        <span class="n">dbcr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">drop_tmp_table_comm</span><span class="p">)</span>
    <span class="c1"># now do the rename:</span>
    <span class="n">alter_command</span> <span class="o">=</span> <span class="s1">&#39;ALTER TABLE &quot;</span><span class="si">{}</span><span class="s1">&quot; RENAME TO &quot;</span><span class="si">{}</span><span class="s1">&quot;;&#39;</span>
    <span class="n">alter_command</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SQLITE_IMG_INFO_TABLE</span><span class="p">,</span> <span class="n">tmp_table</span><span class="p">)</span>
    <span class="n">dbcr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">alter_command</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SQLITE_IMG_INFO_TABLE</span><span class="p">,</span> <span class="n">tmp_table</span><span class="p">))</span>

    <span class="c1"># now recreate the table with the new elements:</span>
    <span class="n">new_key_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">keyname</span> <span class="ow">in</span> <span class="n">current_cols</span> <span class="o">+</span> <span class="n">new_cols</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">keyname</span> <span class="o">!=</span> <span class="n">SQLITE_IMG_INFO_FNAME</span><span class="p">:</span>
            <span class="n">new_key_dict</span><span class="p">[</span><span class="n">keyname</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="n">create_table_for_img_info</span><span class="p">(</span><span class="n">dbcr</span><span class="p">,</span> <span class="n">new_key_dict</span><span class="p">)</span>
    <span class="c1"># and pull the list of fields, in order:</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">dbcr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;select * from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">SQLITE_IMG_INFO_TABLE</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="n">new_flds</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">dbcr</span><span class="o">.</span><span class="n">description</span><span class="p">]</span>
    <span class="n">new_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">db_name_to_info_key</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">new_flds</span><span class="p">]</span>

    <span class="c1"># now populate the new table:</span>
    <span class="n">ins_comm</span> <span class="o">=</span> <span class="s1">&#39;INSERT INTO </span><span class="si">{}</span><span class="s1"> VALUES (</span><span class="si">{}</span><span class="s1">?);&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SQLITE_IMG_INFO_TABLE</span><span class="p">,</span>
                                                     <span class="s1">&#39;?,&#39;</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_keys</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="c1"># now make a list of tuples ordered</span>
    <span class="n">ins_this</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">img_infos</span><span class="p">:</span>
        <span class="n">img_info</span> <span class="o">=</span> <span class="n">img_infos</span><span class="p">[</span><span class="n">img</span><span class="p">]</span>
        <span class="c1"># now build up what into to add, starting with the img filename:</span>
        <span class="n">this_ins</span> <span class="o">=</span> <span class="p">[</span><span class="n">img</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">new_keys</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">current_keys</span><span class="p">:</span>
                <span class="c1"># got it from previous data, so use it:</span>
                <span class="n">this_ins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img_info</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># add it as None:</span>
                <span class="n">this_ins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;None&#39;</span><span class="p">)</span>
        <span class="n">ins_this</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">this_ins</span><span class="p">))</span>
    <span class="c1"># and exectuemany on the insert command:</span>
    <span class="n">dbcr</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="n">ins_comm</span><span class="p">,</span> <span class="n">ins_this</span><span class="p">)</span>

    <span class="c1"># need to drop the _tmp table now as it has been superceded:</span>
    <span class="n">dbcr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">drop_tmp_table_comm</span><span class="p">)</span></div>


<div class="viewcode-block" id="scan_dir_for_db"><a class="viewcode-back" href="../../db.html#ImageMetaTag.db.scan_dir_for_db">[docs]</a><span class="k">def</span> <span class="nf">scan_dir_for_db</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="n">db_file</span><span class="p">,</span> <span class="n">img_tag_req</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">add_strict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">subdir_excl_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">known_file_tags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">no_file_ext</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_timings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">restart_db</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A useful utility that scans a directory on disk for images that can go into a database.</span>
<span class="sd">    This should only be used to build a database from a directory of tagged images that</span>
<span class="sd">    did not previously use a database, or where the database file has been deleted but the</span>
<span class="sd">    images have not.</span>

<span class="sd">    For optimal performance, build the database as the plots are created (or do not delete</span>
<span class="sd">    the database by accident).</span>

<span class="sd">    Arguments:</span>
<span class="sd">     * basedir - the directory to start scanning.</span>
<span class="sd">     * db_file - the database file to save the image metadata to. A pre-existing database file\</span>
<span class="sd">                will fail unless restart_db is True</span>

<span class="sd">    Options:</span>
<span class="sd">     * img_tag_req - a list of tag names that are to be applied/created. See add_strict for \</span>
<span class="sd">                     behaviour when tags are not present in an image.</span>
<span class="sd">     * add_strict - When True, images without all of the img_tag_req are ignored, when False, \</span>
<span class="sd">                    images will be used if they have at least one item in imt_tag_req. Images \</span>
<span class="sd">                    with none of the metadata items are assumed to be from a different source.</span>
<span class="sd">                    Images that are used, with missing tags, will set those tags to &#39;None&#39;.</span>
<span class="sd">     * subdir_excl_list - a list of subdirectories that don&#39;t need to be scanned. [&#39;thumbnail&#39;]\</span>
<span class="sd">                         for instance, will prevent the image thumbnails being included.</span>
<span class="sd">     * no_file_ext - logical to exclude the file extension in the filenames saved to the database.</span>
<span class="sd">     * known_file_tags - if supplied, this is a dict (keyed by filename entry),\</span>
<span class="sd">                         contains a dictionary, structured: {filename: {tag name: value}} \</span>
<span class="sd">                         for the images that are already known (so you don&#39;t need to read them \</span>
<span class="sd">                         from the files themselves as that is slow). This can be useful \</span>
<span class="sd">                         if you have a old backup of a database file that needs updating.</span>
<span class="sd">     * restart_db - if True, the db_file will be restarted from an empty database.</span>
<span class="sd">     * verbose - verbose output.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">db_file</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">restart_db</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;scan_dir_for_db will not work on a pre-existing file unless restart_db</span>
<span class="s1">is True, in which case the database file will be restarted as empty. Use with care.&#39;&#39;&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">known_file_tags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">known_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">known_file_tags</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">known_files</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">return_timings</span><span class="p">:</span>
        <span class="n">prev_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">add_interval</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># total number of entries added</span>
        <span class="n">n_added</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># number of entries added since last timer</span>
        <span class="n">n_add_this_timer</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># and this is the list to return:</span>
        <span class="n">n_adds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">timings_per_add</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">basedir</span><span class="p">)</span>
    <span class="n">first_img</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">,</span> <span class="n">followlinks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">topdown</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">subdir_excl_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dirs</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dirs</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">subdir_excl_list</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">meta_img_format</span> <span class="ow">in</span> <span class="n">META_IMG_FORMATS</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="s1">&#39;*</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">meta_img_format</span><span class="p">):</span>
                <span class="c1"># append to the list, taking off the preceeding &#39;./&#39; and the file extension:</span>
                <span class="k">if</span> <span class="n">root</span> <span class="o">==</span> <span class="s1">&#39;./&#39;</span><span class="p">:</span>
                    <span class="n">img_path</span> <span class="o">=</span> <span class="n">filename</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">img_path</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">root</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">filename</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">no_file_ext</span><span class="p">:</span>
                    <span class="n">img_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">img_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">img_name</span> <span class="o">=</span> <span class="n">img_path</span>

                <span class="c1"># read the metadata:</span>
                <span class="k">if</span> <span class="n">img_name</span> <span class="ow">in</span> <span class="n">known_files</span><span class="p">:</span>
                    <span class="c1"># if we know this file details, then get it:</span>
                    <span class="n">known_files</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">img_name</span><span class="p">)</span>
                    <span class="n">img_info</span> <span class="o">=</span> <span class="n">known_file_tags</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">img_name</span><span class="p">)</span>
                    <span class="n">read_ok</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># otherwise read from disk:</span>
                    <span class="p">(</span><span class="n">read_ok</span><span class="p">,</span> <span class="n">img_info</span><span class="p">)</span> <span class="o">=</span> <span class="n">readmeta_from_image</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">read_ok</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">img_tag_req</span> <span class="ow">and</span> <span class="n">add_strict</span><span class="p">:</span>
                        <span class="c1"># check to see if an image is needed:</span>
                        <span class="n">use_img</span> <span class="o">=</span> <span class="n">check_for_required_keys</span><span class="p">(</span><span class="n">img_info</span><span class="p">,</span> <span class="n">img_tag_req</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">img_tag_req</span><span class="p">:</span>
                        <span class="n">use_img</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="n">x</span> <span class="ow">in</span> <span class="n">img_tag_req</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">img_info</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">use_img</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">use_img</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">first_img</span><span class="p">:</span>
                            <span class="n">dbcn</span><span class="p">,</span> <span class="n">dbcr</span> <span class="o">=</span> <span class="n">open_or_create_db_file</span><span class="p">(</span><span class="n">db_file</span><span class="p">,</span> <span class="n">img_info</span><span class="p">,</span>
                                                                <span class="n">restart_db</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="n">first_img</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">write_img_to_open_db</span><span class="p">(</span><span class="n">dbcr</span><span class="p">,</span> <span class="n">img_name</span><span class="p">,</span> <span class="n">img_info</span><span class="p">,</span>
                                             <span class="n">add_strict</span><span class="o">=</span><span class="n">add_strict</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">img_name</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">return_timings</span><span class="p">:</span>
                            <span class="n">n_added</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">n_add_this_timer</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">n_add_this_timer</span> <span class="o">%</span> <span class="n">add_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">time_interval_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">-</span> <span class="n">prev_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
                                <span class="n">timings_per_add</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time_interval_s</span> <span class="o">/</span> <span class="n">add_interval</span><span class="p">)</span>
                                <span class="n">n_adds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n_added</span><span class="p">)</span>
                                <span class="c1"># increase the add_interval so we don&#39;t swamp</span>
                                <span class="c1"># the processing with timings!</span>
                                <span class="n">add_interval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_added</span><span class="p">))</span>
                                <span class="n">n_add_this_timer</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;len(n_adds)=</span><span class="si">%s</span><span class="s1">, currently every </span><span class="si">%s</span><span class="s1">&#39;</span> \
                                            <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">n_adds</span><span class="p">),</span> <span class="n">add_interval</span><span class="p">))</span>

    <span class="c1"># commit and close, and we are done:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">first_img</span><span class="p">:</span>
        <span class="n">dbcn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">dbcn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">return_timings</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">n_adds</span><span class="p">,</span> <span class="n">timings_per_add</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<span class="k">def</span> <span class="nf">rmfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    os.remove, but does not complain if the file has already been</span>
<span class="sd">    deleted (by a parallel process, for instance).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span>


<span class="k">def</span> <span class="nf">dt_now_str</span><span class="p">():</span>
    <span class="s1">&#39;returns datetime.now(), as a string, in a common format&#39;</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">ImageMetaTag 0.7.8 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2015-2018, British Crown Copyright.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.8.
    </div>
  </body>
</html>